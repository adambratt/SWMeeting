{% extends 'index.html' %}
{% block pagetitle %}{{meeting.name}} Meeting{% endblock %}

{% block content %}
{% if meeting.finished %}
    Done!
{% else %}
<script type='text/javascript'>
    var running = false;
    var overalltime = {{meeting.totaltime}};
    var currenttimer = 0;
    var currenttime = 0;
    var dividetimer = 0;
    var meeting = {{meeting.pk}};
    $(function(){
        $('#add-person').click(function(){
           var person = $('#choose-person option:selected').text();
           var personid = $('#choose-person option:selected').val();
           if (personid){
                if (! $('.person[rel='+personid+']').length){
                    $.get('/ajax/add_attendee/'+meeting+'/'+personid+'/',function (data){
                        var last = $('.timelist').children(':last');
                        var code = "<div class='four columns person' rel='"+personid+"'><a href='#' class='big blue button person-time'>"+person+"</a><div class='totaltime' value='0'>0:00</div></div>";
                        if (last.children().length > 2){
                            $('<div class="row">'+code+'</div>').insertAfter(last);
                        } else {
                           last.append(code)
                        }
                    });
                }else{
                    //person already exists
                }
           }
           return false;
        });
        $('#divide').click(function(){
            var divtime = dividetimer;
            dividetimer = 0;
            $('.listing').append('<li>Time: '+formatTime(overalltime)+' Duration: '+formatTime(divtime)+'</li>');
            return false;
        });
        $('#pause').click(function(){
            if( !currenttimer)
                return false;
            if ( running ){
                running = false;
                $(this).text('Resume');
            } else {
                running = true;
                $(this).text('Pause');
            }
            return false;
        });
        $('#reset').click(function(){
            running = false;
            overalltime = 0;
            currenttime = 0;
            dividetimer = 0;
            currenttimer = 0;
            $('.timelist').find('.totaltime').attr('value', '0');
            return false;
        });
        $('.person-time').live('click',function(){
            if (running == false){
                $('#pause').text('Pause');
            }
            var id = $(this).parent().attr('rel');
            if (currenttimer == id && running)
                return false;
            // Log the last timer
            var lasttimer = $('.timelist').find('.active');
            var lasttimer_id = lasttimer.parent().attr('rel');
            lasttimer.removeClass('active');
            if (lasttimer_id > 0){
                $.post('/ajax/log/'+meeting+'/'+lasttimer_id+'/', {'time_start': overalltime-currenttime, 'time_end': overalltime}, function(data){
                    //Do cool shit
                });
            }
            // Switch to the current timer
            currenttimer = id;
            currenttime = 0;
            running = true;
            $(this).addClass('active');
            $(this).parent().find('.totaltime').effect('pulsate', {times: 1}, 300)
            return false;
        });
        updateTimes();
    });
    function updateTimes(){
        if ( currenttimer > 0 && running ){
            var timer = $('.person[rel='+currenttimer+']').find('.totaltime');
            var currvalue = timer.attr('value');
            timer.attr('value', parseInt(currvalue)+1);
            currenttime += 1;
        }
        if ( running ){
            overalltime += 1;
            dividetimer += 1;
        }
        $('.timelist .person').each(function(){
            var tmptimer = $(this).find('.totaltime');
            tmptimer.text(formatTime(tmptimer.attr('value')));
        });
        $('#fulltime').text(formatTime(overalltime));
        setTimeout("updateTimes()", 1000);
    }
</script>
<div class='row'>
    <div class='twelve columns'>
        <h3><a href='/'>{{group.name}}</a> &raquo; {{meeting.name}}</h3>
        <hr />
    </div>
</div>
<div class='row'>
    <div class='five columns'>
        <form method='post' class='nice custom'>
        <input type='submit' href='#' id='add-person' class='nice button radius white right' value='Add Attendee'>
        <select id='choose-person'>
            <option value=''>Select Person</option>
            {% for x in group.attendee_set.all %}
            <option value='{{x.pk}}'>{{x.name}}</option>
            {% endfor %}
        </select>
        </form>
    </div>
</div>
<div class='timelist'>
    <div class='row'>
    {% for x in meeting.speaker_set.all %}
        <div class="four columns person" rel='{{x.attendee.pk}}'>
            <a href='#' class='big blue button person-time'>{{x.attendee.name}}</a>
            <div class='totaltime' value='{% if x.overalltime %}{{x.overalltime}}{% else %}0{% endif %}'>0:00</div>
        </div>
        {% if forloop.counter|divisibleby:"3" %}
            </div><div class="row">
        {% endif %}
    {% endfor %}
    </div>
</div>
<div class="row">
    <div class='four columns'>
        <a href='#' class='big red button' id='reset'>Reset</a>
        <a href='#' class='big blue button' id='pause'>Resume</a>
    </div>
    <div class='five columns'>
        <a href='#' class='big blue button right nice' id='divide'>Add</a>
        <input type='text' class='input-text' placeholder='Milestone'>
    </div>
    <div class='two offset-by-one columns'>
        <h3 id='fulltime'></h3>
    </div>
</div>
<div>
    <ul class='listing'>
    </ul>
</div>
{% endif %}
{% endblock %}